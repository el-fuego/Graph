window.Graph=function(t){this.$el=$(t.el||t.$el),this.options=_.extend({},this.options,t),this.clear()},window.Graph.prototype={SVG_NS:"http://www.w3.org/2000/svg",options:{width:450,height:140,paddingLeft:20.5,paddingTop:20.5,pointDiameter:8,valueOffsetY:8,rectStep:5,greedLinesCount:5,rectDiagramClass:"rect-diagram",circleDiagramClass:"circle-diagram",verticalGreedClass:"vertical-greed",rectClass:"rect",sectorClass:"sector",shapeClass:"shape",lineClass:"line",pointClass:"point",valueClass:"value",greedLineClass:"greed-line"},_render:function(t,e,i){var r,n=document.createElementNS(this.SVG_NS,t);for(r in e||{})r&&n.setAttributeNS(null,r,e[r]);return $(i||this.$workspace).append(n),$(n)},_renderSector:function(t,e,i,r,n,s,a){var o=n-r>Math.PI;return this._render("path",_.extend({d:"M "+t+","+e+" "+"l "+i*Math.cos(r)+","+i*Math.sin(r)+" "+"A "+i+","+i+",0,"+(o?"1":"0")+",1,"+(t+i*Math.cos(n))+","+(e+i*Math.sin(n))+" z"},s||{}),a)},_renderWorkspace:function(){return $(document.createElementNS(this.SVG_NS,"g")).attr({transform:"translate(0, "+this.options.height+")"}).appendTo($('<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" ></svg>').attr({width:this.options.width,height:this.options.height}).appendTo(this.$el))},clear:function(){this.$workspace&&this.$workspace.remove(),this.$workspace=this._renderWorkspace()},_mergeGraphOptions:function(t){var e={paddingLeft:null!=t.paddingLeft?t.paddingLeft:this.options.paddingLeft,paddingTop:null!=t.paddingTop?t.paddingTop:this.options.paddingTop};return e.graphWidth=t.width||this.options.width-2*e.paddingLeft,e.graphHeight=t.height||this.options.height-2*e.paddingTop,_.extend({},t,e)},_getMaxValue:function(t,e){return e.maxValue||_.max(_.map(t,function(t){return t.value||t}))},_getPointStep:function(t,e){return e.step||e.graphWidth/(t.length-1)},_getGraphPoints:function(t,e){var i=this._getPointStep(t,e),r=this._getMaxValue(t,e);return _.map(t,function(t,n){return e.paddingLeft+i*n+","+(-e.paddingTop-1*(t.value||t)*e.graphHeight/r)})},renderShape:function(t,e){var i=this._mergeGraphOptions(e||{}),r=this._getGraphPoints(t,i);return r.unshift(_.first(r).replace(/,[0-9.-]+/,"")+","+-i.paddingTop),r.push(_.last(r).replace(/,[0-9.-]+/,"")+","+-i.paddingTop),this._render("polyline",_.extend(i,{points:r.join(" "),"class":this.options.shapeClass+" "+(i["class"]||"")}))},renderLine:function(t,e){var i=this._mergeGraphOptions(e||{}),r=this._getGraphPoints(t,i);return this._render("polyline",_.extend(i,{points:r.join(" "),"class":this.options.lineClass}))},renderPoints:function(t,e){var i=this,r=this._mergeGraphOptions(e||{}),n=(r.pointDiameter||this.options.pointDiameter)/2,s=this._getMaxValue(t,r),a=this._getPointStep(t,r);return _.map(t,function(t,e){var o=r.paddingTop+(t.value||t)*r.graphHeight/s;return i._render("circle",_.extend({},"object"==typeof t?t:{},{cx:r.paddingLeft+a*e,cy:-o,r:n,value:t.value||t,"class":i.options.pointClass}))})},_getValueShortText:function(t){return Math.abs(t/1e6)>=1?Math.round(t/1e5)/10+"m":Math.abs(t/1e3)>=1?Math.round(t/100)/10+"k":Math.round(10*t)/10},renderPointsValues:function(t,e){var i=this,r=this._mergeGraphOptions(e||{}),n=this._getMaxValue(t,r),s=this._getPointStep(t,r);return _.map(t,function(t,e){var a=r.paddingTop+(r.pointDiameter||i.options.valueOffsetY)+(t.value||t)*r.graphHeight/n;return i._render("text",_.extend({},"object"==typeof t?t:{},{x:r.paddingLeft+s*e,y:-a,"class":i.options.valueClass})).append(i._getValueShortText(t.value||t))})},_getStepsTotal:function(t,e){var i=0;return _.reduce(t,function(t,r){return t+=e.step(r,i++)},0)},renderRectDiagram:function(t,e){var i=this,r=this._mergeGraphOptions(e||{}),n=r.step||this.options.rectStep,s=r.rectWidth||Math.round(r.graphWidth/t.length-("function"==typeof n?this._getStepsTotal(t,r)/t.length:n)),a=this._getMaxValue(t,r),o=r.paddingLeft,p=this._render("g",{"class":this.options.rectDiagramClass+" "+(r["class"]||"")});return _.map(t,function(t,e){var h="function"==typeof n?n(t,e):Math.round(n),d="function"==typeof s?s(t,e,{step:h}):Math.round(s),l=Math.round((t.value||t)*r.graphHeight/a),u=o;return o=u+h+d,i._render("rect",_.extend({},"object"==typeof t?t:{},{x:u,y:-r.paddingTop-l,width:d,height:l,value:t.value||t,"class":i.options.rectClass+" "+(t["class"]||"")}),p)})},renderRectsValues:function(t,e){var i=this,r=this._mergeGraphOptions(e||{}),n=r.step||this.options.rectStep,s=r.rectWidth||Math.round(r.graphWidth/t.length-("function"==typeof n?this._getStepsTotal(t,r)/t.length:n)),a=this._getMaxValue(t,r),o=r.paddingLeft,p=this._render("g",{"class":this.options.rectDiagramClass+" "+(r["class"]||"")});return _.map(t,function(t,e){var h="function"==typeof n?n(t,e):Math.round(n),d="function"==typeof s?s(t,e,{step:h}):Math.round(s),l=Math.round((t.value||t)*r.graphHeight/a),u=o;return o=u+h+d,i._render("text",_.extend({},"object"==typeof t?t:{},{x:u+d/2,y:-r.paddingTop-l-i.options.valueOffsetY,"class":i.options.valueClass+" "+(t["class"]||"")}),p).append(i._getValueShortText(t.value||t))})},_getGreedStep:function(t,e){if(e.step)return e.step;if(e.valueStep)return e.valueStep*e.graphHeight/t;for(var i=1,r=t/e.count;Math.round(r/10)>0;)r/=10,i=10*i;var n=.1*Math.floor(t/(.1*e.count*i))*i;return Math.floor(n*e.graphHeight/t)},renderVerticalGreed:function(t,e){var i=this._mergeGraphOptions(e||{});i.count||(i.count=this.options.greedLinesCount);for(var r=this._getMaxValue(t,i),n=this._getGreedStep(r,i),s=this._render("g",{"class":this.options.verticalGreedClass+" "+(i["class"]||"")}),a=[],o=i.count;o--;){var p=-i.paddingTop-o*n;a.push(this._render("line",_.extend({},{x1:i.paddingLeft,y1:p,x2:i.paddingLeft+i.graphWidth,y2:p,"class":this.options.greedLineClass}),s))}return a},_renderGradient:function(t){var e=_.min([this.options.width,this.options.height]),i=this._render("filter",{id:"shadow"});this._render("feGaussianBlur",{result:"offset-blur",stdDeviation:e/4},i),this._render("feComposite",{operator:"arithmetic",k1:"3",k2:"0.6",k3:"0",k4:"0","in":"SourceGraphic",in2:"offset-blur"},i),(t||this.$workspace).attr({filter:"url(#shadow)"})},renderCircleDiagram:function(t,e){var i=this,r=this._mergeGraphOptions(e||{}),n=r.valuesTotal||_.reduce(t,function(t,e){return t+(e.value||e)},0),s=_.min([r.graphHeight,r.graphWidth])/2,a=s,o=-s,p=0,h=this._render("g",{"class":this.options.circleDiagramClass+(r["class"]||"")});return this._renderGradient(h),_.map(t,function(t,e){var r=_.extend({},"object"==typeof t?t:{},{"class":i.options.sectorClass+" n"+e+(t["class"]||""),value:t.value||t}),d=p;return p=d+2*(t.value||t)*Math.PI/n,i._renderSector(a,o,s,d,p,r,h)})}};