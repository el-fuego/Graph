window.Graph=function(t){this.$el=$(t.el||t.$el),this.options=_.extend({},this.options,t),this.clear()},window.Graph.prototype={SVG_NS:"http://www.w3.org/2000/svg",options:{width:450,height:140,paddingLeft:10.5,paddingTop:10.5,pointDiameter:8,rectStep:5,greedLinesCount:5,rectDiagramClass:"rect-diagram",circleDiagramClass:"circle-diagram",verticalGreedClass:"vertical-greed",rectClass:"rect",sectorClass:"sector",shapeClass:"shape",lineClass:"line",pointClass:"point",greedLineClass:"greed-line"},_render:function(t,e,r){var i,n=document.createElementNS(this.SVG_NS,t);for(i in e||{})i&&n.setAttributeNS(null,i,e[i]);return $(r||this.$workspace).append(n),$(n)},_renderSector:function(t,e,r,i,n,s,a){var o=n-i>Math.PI;return this._render("path",_.extend({d:"M "+t+","+e+" "+"l "+r*Math.cos(i)+","+r*Math.sin(i)+" "+"A "+r+","+r+",0,"+(o?"1":"0")+",1,"+(t+r*Math.cos(n))+","+(e+r*Math.sin(n))+" z"},s||{}),a)},_renderWorkspace:function(){return $(document.createElementNS(this.SVG_NS,"g")).attr({transform:"translate(0, "+this.options.height+")"}).appendTo($('<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" ></svg>').attr({width:this.options.width,height:this.options.height}).appendTo(this.$el))},clear:function(){this.$workspace&&this.$workspace.remove(),this.$workspace=this._renderWorkspace()},_mergeGraphOptions:function(t){var e={paddingLeft:t.paddingLeft||this.options.paddingLeft,paddingTop:t.paddingTop||this.options.paddingTop};return e.graphWidth=t.width||this.options.width-2*e.paddingLeft,e.graphHeight=t.height||this.options.height-2*e.paddingTop,_.extend({},t,e)},_getMaxValue:function(t,e){return e.maxValue||_.max(_.map(t,function(t){return t.value||t}))},_getPointStep:function(t,e){return e.step||e.graphWidth/(t.length-1)},_getGraphPoints:function(t,e){var r=this._getPointStep(t,e),i=this._getMaxValue(t,e);return _.map(t,function(t,n){return e.paddingLeft+r*n+","+(-e.paddingTop-1*(t.value||t)*e.graphHeight/i)})},renderShape:function(t,e){var r=this._mergeGraphOptions(e||{}),i=this._getGraphPoints(t,r);return i.unshift(_.first(i).replace(/,[0-9.-]+/,"")+","+-r.paddingTop),i.push(_.last(i).replace(/,[0-9.-]+/,"")+","+-r.paddingTop),this._render("polyline",_.extend(r,{points:i.join(" "),"class":this.options.shapeClass+" "+(r["class"]||"")}))},renderLine:function(t,e){var r=this._mergeGraphOptions(e||{}),i=this._getGraphPoints(t,r);return this._render("polyline",_.extend(r,{points:i.join(" "),"class":this.options.lineClass}))},renderPoints:function(t,e){var r=this,i=this._mergeGraphOptions(e||{}),n=(i.pointDiameter||this.options.pointDiameter)/2,s=this._getMaxValue(t,i),a=this._getPointStep(t,i);return _.map(t,function(t,e){var o=i.paddingTop+(t.value||t)*i.graphHeight/s;return r._render("circle",_.extend({},"object"==typeof t?t:{},{cx:i.paddingLeft+a*e,cy:-o,r:n,value:t.value||t,"class":r.options.pointClass}))})},_getStepsTotal:function(t,e){var r=0;return _.reduce(t,function(t,i){return t+=e.step(i,r++)},0)},renderRectDiagram:function(t,e){var r=this,i=this._mergeGraphOptions(e||{}),n=i.step||this.options.rectStep,s=i.rectWidth||Math.round(i.graphWidth/t.length-("function"==typeof n?this._getStepsTotal(t,i)/t.length:n)),a=this._getMaxValue(t,i),o=i.paddingLeft,p=this._render("g",{"class":this.options.rectDiagramClass+" "+(i["class"]||"")});return _.map(t,function(t,e){var h="function"==typeof n?n(t,e):Math.round(n),d="function"==typeof s?s(t,e,{step:h}):Math.round(s),l=Math.round((t.value||t)*i.graphHeight/a),c=o;return o=c+h+d,r._render("rect",_.extend({},"object"==typeof t?t:{},{x:c,y:-i.paddingTop-l,width:d,height:l,value:t.value||t,"class":r.options.rectClass+" "+(t["class"]||"")}),p)})},_getGreedStep:function(t,e){if(e.step)return e.step;if(e.valueStep)return e.valueStep*e.graphHeight/t;for(var r=1,i=t/e.count;Math.round(i/10)>0;)i/=10,r=10*r;var n=.1*Math.floor(t/(.1*e.count*r))*r;return Math.floor(n*e.graphHeight/t)},renderVerticalGreed:function(t,e){var r=this._mergeGraphOptions(e||{});r.count||(r.count=this.options.greedLinesCount);for(var i=this._getMaxValue(t,r),n=this._getGreedStep(i,r),s=this._render("g",{"class":this.options.verticalGreedClass+" "+(r["class"]||"")}),a=[],o=r.count;o--;){var p=-r.paddingTop-o*n;a.push(this._render("line",_.extend({},{x1:r.paddingLeft,y1:p,x2:r.paddingLeft+r.graphWidth,y2:p,"class":this.options.greedLineClass}),s))}return a},_renderGradient:function(t){var e=_.min([this.options.width,this.options.height]),r=this._render("filter",{id:"shadow"});this._render("feGaussianBlur",{result:"offset-blur",stdDeviation:e/4},r),this._render("feComposite",{operator:"arithmetic",k1:"3",k2:"0.6",k3:"0",k4:"0","in":"SourceGraphic",in2:"offset-blur"},r),(t||this.$workspace).attr({filter:"url(#shadow)"})},renderCircleDiagram:function(t,e){var r=this,i=this._mergeGraphOptions(e||{}),n=i.valuesTotal||_.reduce(t,function(t,e){return t+(e.value||e)},0),s=_.min([i.graphHeight,i.graphWidth])/2,a=s,o=-s,p=0,h=this._render("g",{"class":this.options.circleDiagramClass+(i["class"]||"")});return this._renderGradient(h),_.map(t,function(t,e){var i=_.extend({},"object"==typeof t?t:{},{"class":r.options.sectorClass+" n"+e+(t["class"]||""),value:t.value||t}),d=p;return p=d+2*(t.value||t)*Math.PI/n,r._renderSector(a,o,s,d,p,i,h)})}};