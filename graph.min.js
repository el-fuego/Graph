window.Graph=function(t){this.$el=$(t.el||t.$el),this.options=_.extend({},this.options,t),this.clear()},window.Graph.prototype={SVG_NS:"http://www.w3.org/2000/svg",options:{width:450,height:140,paddingLeft:20.5,paddingTop:20.5,pointDiameter:8,valueOffsetY:4,rectStep:5,greedLinesCount:5,rectDiagramClass:"rect-diagram",circleDiagramClass:"circle-diagram",verticalGreedClass:"vertical-greed",rectClass:"rect",rectNameClass:"rect-name",sectorClass:"sector",shapeClass:"shape",lineClass:"line",pointClass:"point",valueClass:"value",greedLineClass:"greed-line",backgroundColor:"#F5F5F5"},_render:function(t,e,r){var i,n=document.createElementNS(this.SVG_NS,t);for(i in e||{})i&&n.setAttributeNS(null,i,e[i]);return $(r||this.$workspace).append(n),$(n)},_renderWorkspace:function(){return $(document.createElementNS(this.SVG_NS,"g")).attr({transform:"translate(0, "+this.options.height+")"}).appendTo($('<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" ></svg>').attr({width:this.options.width,height:this.options.height}).appendTo(this.$el))},_renderGroup:function(t,e){return this._render("g",{"class":t+(e&&e["class"]?" "+e["class"]:"")})},clear:function(){this.$workspace&&this.$workspace.remove(),this.$workspace=this._renderWorkspace()},_appendTextNodes:function(t,e,r){var i=(""+t).split("\n");if(r.append(i.shift()),i.length)for(var n,s=+(""+r.css("font-size")).replace(/[^0-9]/g,"");n=i.shift();)this._render("tspan",{x:e.x,dy:s},r).append(n)},_mergeGraphOptions:function(t){var e={paddingLeft:null!=t.paddingLeft?t.paddingLeft:this.options.paddingLeft,paddingTop:null!=t.paddingTop?t.paddingTop:this.options.paddingTop};return e.graphWidth=t.width||this.options.width-2*e.paddingLeft,e.graphHeight=t.height||this.options.height-2*e.paddingTop,_.extend({},t,e)},_getValue:function(t){return"object"==typeof t?t.value||0:t||0},_getMaxValue:function(t,e){var r=this;return e.maxValue||_.max(_.map(t,function(t){return r._getValue(t)}))},_getValueShortText:function(t){return Math.abs(t/1e6)>=1?Math.round(t/1e5)/10+"m":Math.abs(t/1e3)>=1?Math.round(t/100)/10+"k":Math.round(10*t)/10}},_.extend(window.Graph.prototype,{_renderSector:function(t,e,r,i,n,s,a){var o=n-i>Math.PI;return n-i>=2*Math.PI&&(n=i-1e-5+2*Math.PI),this._render("path",_.extend({d:"M "+t+","+e+" "+"l "+r*Math.cos(i)+","+r*Math.sin(i)+" "+"A "+r+","+r+",0,"+(o?"1":"0")+",1,"+(t+r*Math.cos(n))+","+(e+r*Math.sin(n))+" z"},s||{}),a)},renderCircleDiagram:function(t,e){var r=this,i=this._mergeGraphOptions(e||{}),n=i.valuesTotal||_.reduce(t,function(t,e){return t+r._getValue(e)},0),s=_.min([i.graphHeight,i.graphWidth])/2,a=s,o=-s,h=0,p=this._render("g",{"class":this.options.circleDiagramClass+(i["class"]||"")});return this._renderRadialGradient(p),_.map(t,function(t,e){var i=_.extend({},"object"==typeof t?t:{},{"class":r.options.sectorClass+" n"+e+(t["class"]||""),value:r._getValue(t)}),d=h;return h=d+2*r._getValue(t)*Math.PI/n,r._renderSector(a,o,s,d,h,i,p)})}}),_.extend(window.Graph.prototype,{_renderRadialGradient:function(t){var e=_.min([this.options.width,this.options.height]),r=this._render("filter",{id:"shadow"});this._render("feGaussianBlur",{result:"offset-blur",stdDeviation:e/4},r),this._render("feComposite",{operator:"arithmetic",k1:"3",k2:"0.6",k3:"0",k4:"0","in":"SourceGraphic",in2:"offset-blur"},r),(t||this.$workspace).attr({filter:"url(#shadow)"})},_renderTextGlow:function(t,e){var r=this._render("filter",{id:"text-glow"});this._render("feFlood",{"flood-color":t.backgroundColor||this.options.backgroundColor},r),this._render("feComposite",{in2:"SourceGraphic",operator:"in"},r),this._render("feGaussianBlur",{stdDeviation:2},r);var i=this._render("feComponentTransfer",{},r);this._render("feFuncA",{type:"gamma",exponent:1,amplitude:6},i),this._render("feComposite",{"in":"SourceGraphic"},r),(e||this.$workspace).attr({filter:"url(#text-glow)"})}}),_.extend(window.Graph.prototype,{_getGreedStep:function(t,e){if(e.step)return e.step;if(e.valueStep)return e.valueStep*e.graphHeight/t;for(var r=1,i=t/e.count;Math.round(i/10)>0;)i/=10,r=10*r;var n=.1*Math.floor(t/(.1*e.count*r))*r;return Math.floor(n*e.graphHeight/t)},renderVerticalGreed:function(t,e){var r=this._mergeGraphOptions(e||{});r.count||(r.count=this.options.greedLinesCount);for(var i=this._getMaxValue(t,r),n=this._getGreedStep(i,r),s=this._render("g",{"class":this.options.verticalGreedClass+" "+(r["class"]||"")}),a=[],o=r.count;o--;){var h=-r.paddingTop-o*n;a.push(this._render("line",_.extend({},{x1:r.paddingLeft,y1:h,x2:r.paddingLeft+r.graphWidth,y2:h,"class":this.options.greedLineClass}),s))}return a}}),_.extend(window.Graph.prototype,{_getPointsGraphOptions:function(t,e){var r=this._mergeGraphOptions(e||{});return r.pointRadius=(r.pointDiameter||this.options.pointDiameter)/2,r.maxValue=this._getMaxValue(t,r),r.step=this._getPointStep(t,r),r},_getGraphPoints:function(t,e){var r=this,i=this._getPointStep(t,e),n=this._getMaxValue(t,e);return _.map(t,function(t,s){return e.paddingLeft+i*s+","+(-e.paddingTop-r._getValue(t)*e.graphHeight/n)})},_getPointStep:function(t,e){return e.step||e.graphWidth/(t.length-1)},renderShape:function(t,e){var r=this._mergeGraphOptions(e||{}),i=this._getGraphPoints(t,r);return i.unshift(_.first(i).replace(/,[0-9.-]+/,"")+","+-r.paddingTop),i.push(_.last(i).replace(/,[0-9.-]+/,"")+","+-r.paddingTop),this._render("polyline",_.extend(r,{points:i.join(" "),"class":this.options.shapeClass+" "+(r["class"]||"")})),this},renderLine:function(t,e){var r=this._mergeGraphOptions(e||{}),i=this._getGraphPoints(t,r);return this._render("polyline",_.extend(r,{points:i.join(" "),"class":this.options.lineClass})),this},renderPoints:function(t,e){var r=this,i=this._getPointsGraphOptions(t,e);return _.each(t,function(t,e){var n=i.paddingTop+r._getValue(t)*i.graphHeight/i.maxValue;r._render("circle",_.extend({},"object"==typeof t?t:{},{cx:i.paddingLeft+i.step*e,cy:-n,r:i.pointRadius,value:r._getValue(t),"class":r.options.pointClass}))}),this},renderPointsValues:function(t,e){var r=this,i=this._getPointsGraphOptions(t,e),n=this._renderGroup(i["class"]||"");return this._renderTextGlow(i,n),_.each(t,function(t,e){var s=i.paddingTop+r.options.valueOffsetY+i.pointRadius+r._getValue(t)*i.graphHeight/i.maxValue,a=i.paddingLeft+i.step*e,o=r._render("text",_.extend({},"object"==typeof t?t:{},{x:a,y:-s,"class":r.options.valueClass}),n);r._appendTextNodes(i.fullText?r._getValue(t):r._getValueShortText(r._getValue(t)),{x:a},o)}),this}}),_.extend(window.Graph.prototype,{_getDefaultRectWidth:function(t,e){return Math.round(e.graphWidth/t.length-("function"==typeof e.step?this._getRectStepsTotal(t,e)/t.length:e.step))},_getRectGraphOptions:function(t,e){var r=this._mergeGraphOptions(e);return r.step=r.step||this.options.rectStep,r.defaultRectWidth=this._getDefaultRectWidth(t,r),r.rectWidth=r.rectWidth||r.defaultRectWidth,r.maxValue=this._getMaxValue(t,r),r.previousEndsX=r.paddingLeft,r},_getRectOptions:function(t,e,r){var i={},n="function"==typeof r.step?r.step(t,e,this.options.rectStep):Math.round(r.step);return i.width="function"==typeof r.rectWidth?r.rectWidth(t,e,r.defaultRectWidth):Math.round(r.rectWidth),i.height=Math.round(this._getValue(t)*r.graphHeight/r.maxValue),i.x=r.previousEndsX,i.y=-r.paddingTop-i.height,r.previousEndsX=i.x+n+i.width,i},_getRectStepsTotal:function(t,e){var r=0;return _.reduce(t,function(t,i){return t+=e.step(i,r++)},0)},_renderRect:function(t,e,r){return this._render("rect",{x:e.x,y:e.y,width:e.width,height:e.height,value:this._getValue(t),"class":this.options.rectClass+" "+(t["class"]||"")},r)},_renderRectName:function(t,e,r){var i=e.x+e.width/2,n=this._render("text",{x:i,y:e.y+this.options.valueOffsetY+e.height,"class":this.options.rectNameClass+" "+(t["class"]||"")},r);return this._appendTextNodes(t.name,{x:i},n),n},_renderRectValue:function(t,e,r,i){var n=e.x+e.width/2,s=this._render("text",_.extend({},"object"==typeof t?t:{},{x:n,y:e.y-this.options.valueOffsetY,"class":this.options.valueClass+" "+(t["class"]||"")}),i);return this._appendTextNodes(r.fullText?this._getValue(t):this._getValueShortText(this._getValue(t)),{x:n},s),s},renderRectDiagram:function(t,e){var r=this,i=this._getRectGraphOptions(t,e||{}),n=this._renderGroup(this.options.rectDiagramClass,i),s=this._renderGroup(this.options.rectDiagramClass,i);return this._renderTextGlow(i,s),_.each(t,function(t,e){var a=r._getRectOptions(t,e,i);t.name&&r._renderRectName(t,a,s),r._renderRect(t,a,n)}),this},renderRectsValues:function(t,e){var r=this,i=this._getRectGraphOptions(t,e||{}),n=this._renderGroup(this.options.rectDiagramClass,i);return this._renderTextGlow(i,n),_.each(t,function(t,e){var s=r._getRectOptions(t,e,i);r._renderRectValue(t,s,i,n)}),this}});