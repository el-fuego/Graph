window.Graph=function(t){this.$el=$(t.el||t.$el),this.options=_.extend({},this.options,t),this.clear()},window.Graph.prototype={SVG_NS:"http://www.w3.org/2000/svg",options:{width:450,height:140,paddingLeft:20.5,paddingTop:20.5,pointDiameter:8,valueOffsetY:8,rectStep:5,greedLinesCount:5,rectDiagramClass:"rect-diagram",circleDiagramClass:"circle-diagram",verticalGreedClass:"vertical-greed",rectClass:"rect",sectorClass:"sector",shapeClass:"shape",lineClass:"line",pointClass:"point",valueClass:"value",greedLineClass:"greed-line"},_render:function(t,e,n){var r,i=document.createElementNS(this.SVG_NS,t);for(r in e||{})r&&i.setAttributeNS(null,r,e[r]);return $(n||this.$workspace).append(i),$(i)},_renderSector:function(t,e,n,r,i,a,s){var o=i-r>Math.PI;return i-r>=2*Math.PI&&(i=r-1e-5+2*Math.PI),this._render("path",_.extend({d:"M "+t+","+e+" "+"l "+n*Math.cos(r)+","+n*Math.sin(r)+" "+"A "+n+","+n+",0,"+(o?"1":"0")+",1,"+(t+n*Math.cos(i))+","+(e+n*Math.sin(i))+" z"},a||{}),s)},_renderWorkspace:function(){return $(document.createElementNS(this.SVG_NS,"g")).attr({transform:"translate(0, "+this.options.height+")"}).appendTo($('<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" ></svg>').attr({width:this.options.width,height:this.options.height}).appendTo(this.$el))},clear:function(){this.$workspace&&this.$workspace.remove(),this.$workspace=this._renderWorkspace()},_mergeGraphOptions:function(t){var e={paddingLeft:null!=t.paddingLeft?t.paddingLeft:this.options.paddingLeft,paddingTop:null!=t.paddingTop?t.paddingTop:this.options.paddingTop};return e.graphWidth=t.width||this.options.width-2*e.paddingLeft,e.graphHeight=t.height||this.options.height-2*e.paddingTop,_.extend({},t,e)},_getValue:function(t){return"object"==typeof t?t.value||0:t||0},_getMaxValue:function(t,e){var n=this;return e.maxValue||_.max(_.map(t,function(t){return n._getValue(t)}))},_getPointStep:function(t,e){return e.step||e.graphWidth/(t.length-1)},_getGraphPoints:function(t,e){var n=this,r=this._getPointStep(t,e),i=this._getMaxValue(t,e);return _.map(t,function(t,a){return e.paddingLeft+r*a+","+(-e.paddingTop-n._getValue(t)*e.graphHeight/i)})},renderShape:function(t,e){var n=this._mergeGraphOptions(e||{}),r=this._getGraphPoints(t,n);return r.unshift(_.first(r).replace(/,[0-9.-]+/,"")+","+-n.paddingTop),r.push(_.last(r).replace(/,[0-9.-]+/,"")+","+-n.paddingTop),this._render("polyline",_.extend(n,{points:r.join(" "),"class":this.options.shapeClass+" "+(n["class"]||"")}))},renderLine:function(t,e){var n=this._mergeGraphOptions(e||{}),r=this._getGraphPoints(t,n);return this._render("polyline",_.extend(n,{points:r.join(" "),"class":this.options.lineClass}))},renderPoints:function(t,e){var n=this,r=this._mergeGraphOptions(e||{}),i=(r.pointDiameter||this.options.pointDiameter)/2,a=this._getMaxValue(t,r),s=this._getPointStep(t,r);return _.map(t,function(t,e){var o=r.paddingTop+n._getValue(t)*r.graphHeight/a;return n._render("circle",_.extend({},"object"==typeof t?t:{},{cx:r.paddingLeft+s*e,cy:-o,r:i,value:n._getValue(t),"class":n.options.pointClass}))})},_getValueShortText:function(t){return Math.abs(t/1e6)>=1?Math.round(t/1e5)/10+"m":Math.abs(t/1e3)>=1?Math.round(t/100)/10+"k":Math.round(10*t)/10},renderPointsValues:function(t,e){var n=this,r=this._mergeGraphOptions(e||{}),i=this._getMaxValue(t,r),a=this._getPointStep(t,r);return _.map(t,function(t,e){var s=r.paddingTop+(r.pointDiameter||n.options.valueOffsetY)+n._getValue(t)*r.graphHeight/i;return n._render("text",_.extend({},"object"==typeof t?t:{},{x:r.paddingLeft+a*e,y:-s,"class":n.options.valueClass})).append(n._getValueShortText(n._getValue(t)))})},_getStepsTotal:function(t,e){var n=0;return _.reduce(t,function(t,r){return t+=e.step(r,n++)},0)},renderRectDiagram:function(t,e){var n=this,r=this._mergeGraphOptions(e||{}),i=r.step||this.options.rectStep,a=r.rectWidth||Math.round(r.graphWidth/t.length-("function"==typeof i?this._getStepsTotal(t,r)/t.length:i)),s=this._getMaxValue(t,r),o=r.paddingLeft,p=this._render("g",{"class":this.options.rectDiagramClass+" "+(r["class"]||"")});return _.map(t,function(t,e){var h="function"==typeof i?i(t,e):Math.round(i),d="function"==typeof a?a(t,e,{step:h}):Math.round(a),u=Math.round(n._getValue(t)*r.graphHeight/s),l=o;return o=l+h+d,n._render("rect",_.extend({},"object"==typeof t?t:{},{x:l,y:-r.paddingTop-u,width:d,height:u,value:n._getValue(t),"class":n.options.rectClass+" "+(t["class"]||"")}),p)})},renderRectsValues:function(t,e){var n=this,r=this._mergeGraphOptions(e||{}),i=r.step||this.options.rectStep,a=r.rectWidth||Math.round(r.graphWidth/t.length-("function"==typeof i?this._getStepsTotal(t,r)/t.length:i)),s=this._getMaxValue(t,r),o=r.paddingLeft,p=this._render("g",{"class":this.options.rectDiagramClass+" "+(r["class"]||"")});return _.map(t,function(t,e){var h="function"==typeof i?i(t,e):Math.round(i),d="function"==typeof a?a(t,e,{step:h}):Math.round(a),u=Math.round(n._getValue(t)*r.graphHeight/s),l=o;return o=l+h+d,n._render("text",_.extend({},"object"==typeof t?t:{},{x:l+d/2,y:-r.paddingTop-u-n.options.valueOffsetY,"class":n.options.valueClass+" "+(t["class"]||"")}),p).append(n._getValueShortText(n._getValue(t)))})},_getGreedStep:function(t,e){if(e.step)return e.step;if(e.valueStep)return e.valueStep*e.graphHeight/t;for(var n=1,r=t/e.count;Math.round(r/10)>0;)r/=10,n=10*n;var i=.1*Math.floor(t/(.1*e.count*n))*n;return Math.floor(i*e.graphHeight/t)},renderVerticalGreed:function(t,e){var n=this._mergeGraphOptions(e||{});n.count||(n.count=this.options.greedLinesCount);for(var r=this._getMaxValue(t,n),i=this._getGreedStep(r,n),a=this._render("g",{"class":this.options.verticalGreedClass+" "+(n["class"]||"")}),s=[],o=n.count;o--;){var p=-n.paddingTop-o*i;s.push(this._render("line",_.extend({},{x1:n.paddingLeft,y1:p,x2:n.paddingLeft+n.graphWidth,y2:p,"class":this.options.greedLineClass}),a))}return s},_renderGradient:function(t){var e=_.min([this.options.width,this.options.height]),n=this._render("filter",{id:"shadow"});this._render("feGaussianBlur",{result:"offset-blur",stdDeviation:e/4},n),this._render("feComposite",{operator:"arithmetic",k1:"3",k2:"0.6",k3:"0",k4:"0","in":"SourceGraphic",in2:"offset-blur"},n),(t||this.$workspace).attr({filter:"url(#shadow)"})},renderCircleDiagram:function(t,e){var n=this,r=this._mergeGraphOptions(e||{}),i=r.valuesTotal||_.reduce(t,function(t,e){return t+n._getValue(e)},0),a=_.min([r.graphHeight,r.graphWidth])/2,s=a,o=-a,p=0,h=this._render("g",{"class":this.options.circleDiagramClass+(r["class"]||"")});return this._renderGradient(h),_.map(t,function(t,e){var r=_.extend({},"object"==typeof t?t:{},{"class":n.options.sectorClass+" n"+e+(t["class"]||""),value:n._getValue(t)}),d=p;return p=d+2*n._getValue(t)*Math.PI/i,n._renderSector(s,o,a,d,p,r,h)})}};