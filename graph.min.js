window.Graph=function(a){this.$el=$(a.el||a.$el),this.options=_.extend({},this.options,a),this.clear()},window.Graph.prototype={SVG_NS:"http://www.w3.org/2000/svg",options:{width:450,height:140,paddingLeft:20.5,paddingTop:20.5,pointDiameter:8,valueOffsetY:4,rectStep:5,greedLinesCount:5,footnotePointsMargin:20,footnoteLength:200,minSectorsCountForFootnoteResize:4,sectorArcLengthForFootnoteResize:50,minAdjacentArcsLengthDifference:75,rectDiagramClass:"rect-diagram",circleDiagramClass:"circle-diagram",verticalGreedClass:"vertical-greed",rectClass:"rect",rectNameClass:"rect-name",sectorClass:"sector",sectorNameClass:"sector-name",sectorFootnote:"sector-name-line",shapeClass:"shape",lineClass:"line",pointClass:"point",valueClass:"value",greedLineClass:"greed-line",backgroundColor:"#F5F5F5"},_render:function(a,b,c){var d,e=document.createElementNS(this.SVG_NS,a);for(d in b||{})d&&e.setAttributeNS(null,d,b[d]);return $(c||this.$workspace).append(e),$(e)},_renderWorkspace:function(){return $(document.createElementNS(this.SVG_NS,"g")).attr({transform:"translate(0, "+this.options.height+")"}).appendTo($('<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" ></svg>').attr({width:this.options.width,height:this.options.height}).appendTo(this.$el))},_renderGroup:function(a,b){return this._render("g",{"class":a+(b&&b["class"]?" "+b["class"]:"")})},clear:function(){this.$workspace&&this.$workspace.remove(),this.$workspace=this._renderWorkspace()},_appendTextNodes:function(a,b,c){var d=a.toString().split("\n"),e=+c.css("font-size").toString().replace(/[^0-9]/g,""),f=b.isBottomBaseLine?b.y:b.y+e;if(this._render("tspan",{x:b.x,y:f},c).append(b.isBottomBaseLine?d.pop():d.shift()),d.length)for(var g;g=b.isBottomBaseLine?d.pop():d.shift();)f+=b.isBottomBaseLine?-e:e,this._render("tspan",{x:b.x,y:f},c).append(g)},_mergeGraphOptions:function(a){var b={paddingLeft:null!=a.paddingLeft?a.paddingLeft:this.options.paddingLeft,paddingTop:null!=a.paddingTop?a.paddingTop:this.options.paddingTop};return b.graphWidth=a.width||this.options.width-2*b.paddingLeft,b.graphHeight=a.height||this.options.height-2*b.paddingTop,_.extend({},a,b)},_getValue:function(a){return("object"==typeof a?a.value:a)||0},_getMaxValue:function(a,b){var c=this;return b.maxValue||_.max(_.map(a,function(a){return c._getValue(a)}))},_getValueShortText:function(a){return Math.abs(a/1e6)>=1?Math.round(a/1e5)/10+"\nмлн.":Math.abs(a/1e3)>=1?Math.round(a/100)/10+"\nтыс.":Math.round(10*a)/10}},_.extend(window.Graph.prototype,{_renderSector:function(a,b,c){var d=b.endDegree-b.startDegree>Math.PI;return b.endDegree-b.startDegree>=2*Math.PI&&(b.endDegree=b.startDegree-1e-5+2*Math.PI),this._render("path",_.extend({},b,{d:"M "+b.x+","+b.y+" "+"l "+b.radius*Math.cos(b.startDegree)+","+b.radius*Math.sin(b.startDegree)+" "+"A "+b.radius+","+b.radius+",0,"+(d?"1":"0")+",1,"+(b.x+b.radius*Math.cos(b.endDegree))+","+(b.y+b.radius*Math.sin(b.endDegree))+" z"}),c)},_getCircleDiagramOptions:function(a,b){var c=this,d=this._mergeGraphOptions(b);return d.valuesTotal=d.valuesTotal||_.reduce(a,function(a,b){return a+c._getValue(b)},0),d.radius=_.min([d.graphHeight,d.graphWidth])/2,d.x=this.options.width/2,d.y=-this.options.height/2,d.startDegree=d.startDegree||0,d.endDegree=d.startDegree||0,d.footnotePointsMargin=b.footnotePointsMargin||this.options.footnotePointsMargin,d},_getSectorOptions:function(a,b,c,d){return _.extend({},"object"==typeof a?a:{},{"class":this.options.sectorClass+" n"+b+" "+(a["class"]||""),value:this._getValue(a),name:a.name,startDegree:d.endDegree,endDegree:d.endDegree+2*this._getValue(a)*Math.PI/c.valuesTotal,radius:c.radius,x:c.x,y:c.y,footnotePointsMargin:c.footnotePointsMargin,footnoteLength:c.footnoteLength})},renderCircleDiagram:function(a,b){var c,d,e=this,f=this._getCircleDiagramOptions(a,b||{}),g=f,h=this._render("g",{"class":this.options.circleDiagramClass+(f["class"]||"")}),i=this._render("g",{"class":this.options.circleDiagramClass+(f["class"]||"")});return this._renderRadialGradient(h),c=a.length,_.map(a,function(a,b){var j=this._getSectorOptions(a,b,f,g);g=j,j.sectorsCount=c,j.previousSectorNameRenderResult=d,e._renderSector(a,j,h),d=null!=j.name?e._renderSectorName(a,j,i):null},this),this},_renderSectorNameText:function(a,b,c){var d={x:b.x+(b.isLeftSide?-b.footnotePointsMargin:b.footnotePointsMargin)/2,y:b.y},e=this._render("text",{x:d.x,y:d.y,"class":this.options.sectorNameClass+" "+(a["class"]||""),"text-anchor":b.isLeftSide?"end":"start"},c);return d.y+=-e.css("font-size").toString().replace(/[^0-9]/g,"")-3,e.attr("y",d.y),this._appendTextNodes(a.name,d,e),e},_renderSectorName:function(a,b,c){for(var d,e,f,g,h,i=this.options.sectorArcLengthForFootnoteResize,j=(b.endDegree+b.startDegree)/2,k=j,l=b.previousSectorNameRenderResult,m=b.footnotePointsMargin,n=180*(b.endDegree-b.startDegree)/Math.PI,o=Math.round(Math.PI*b.radius*n/180);k>2*Math.PI;)k+=2*-Math.PI;d=k>Math.PI/2&&k<1.5*Math.PI,e=k>Math.PI,f={x:b.x+b.radius*Math.cos(j),y:b.y+b.radius*Math.sin(j)},g={x:Math.round(f.x+(d?-b.footnotePointsMargin:b.footnotePointsMargin)),y:Math.round(f.y+(e?-b.footnotePointsMargin:b.footnotePointsMargin))+.5},b.sectorsCount>=this.options.minSectorsCountForFootnoteResize&&i>o&&(!l||l.sectorArcLength<i||l&&Math.abs(l.sectorArcLength-o)<=this.options.minAdjacentArcsLengthDifference&&(i>o||l.sectorArcLength<i))&&(h=10>o||l&&l.sectorArcLength<i&&l.isTopSide===e&&l.isLeftSide===d?2:1,g.y+=h*(e?-m:m)),this._render("line",{x1:f.x,y1:f.y,x2:g.x,y2:g.y,"class":this.options.sectorFootnote+" "+(a["class"]||"")},c);var p=this._renderSectorNameText(a,_.extend({},b,{centerDegree:j,sectorArcCenter:f,isLeftSide:d,isTopSide:e,x:g.x,y:g.y}),c),q=b.footnoteLength||(p[0]&&p[0].offsetWidth?p[0].offsetWidth+b.footnotePointsMargin:this.options.footnoteLength);return this._render("line",{x1:g.x,y1:g.y,x2:g.x+(d?-q:q),y2:g.y,"class":this.options.sectorFootnote+" "+(a["class"]||"")},c),{sectorArcLength:o,isTopSide:e,isLeftSide:d}}}),_.extend(window.Graph.prototype,{_renderRadialGradient:function(a){var b=_.min([this.options.width,this.options.height]),c=this._render("filter",{id:"shadow"});this._render("feGaussianBlur",{result:"offset-blur",stdDeviation:b/4},c),this._render("feComposite",{operator:"arithmetic",k1:"3",k2:"0.6",k3:"0",k4:"0","in":"SourceGraphic",in2:"offset-blur"},c),(a||this.$workspace).attr({filter:"url(#shadow)"})},_renderTextGlow:function(a,b){var c=this._render("filter",{id:"text-glow"});this._render("feFlood",{"flood-color":a.backgroundColor||this.options.backgroundColor},c),this._render("feComposite",{in2:"SourceGraphic",operator:"in"},c),this._render("feGaussianBlur",{stdDeviation:2},c);var d=this._render("feComponentTransfer",{},c);this._render("feFuncA",{type:"gamma",exponent:1,amplitude:6},d),this._render("feComposite",{"in":"SourceGraphic"},c),(b||this.$workspace).attr({filter:"url(#text-glow)"})}}),_.extend(window.Graph.prototype,{_getGreedStep:function(a,b){if(b.step)return b.step;if(b.valueStep)return b.valueStep*b.graphHeight/a;for(var c=1,d=a/b.count;Math.round(d/10)>0;)d/=10,c=10*c;var e=.1*Math.floor(a/(.1*b.count*c))*c;return Math.floor(e*b.graphHeight/a)},renderVerticalGreed:function(a,b){var c=this._mergeGraphOptions(b||{});c.count||(c.count=this.options.greedLinesCount);for(var d=this._getMaxValue(a,c),e=this._getGreedStep(d,c),f=this._render("g",{"class":this.options.verticalGreedClass+" "+(c["class"]||"")}),g=[],h=c.count;h--;){var i=-c.paddingTop-h*e;g.push(this._render("line",_.extend({},{x1:c.paddingLeft,y1:i,x2:c.paddingLeft+c.graphWidth,y2:i,"class":this.options.greedLineClass}),f))}return g}}),_.extend(window.Graph.prototype,{_getPointsGraphOptions:function(a,b){var c=this._mergeGraphOptions(b||{});return c.pointRadius=(c.pointDiameter||this.options.pointDiameter)/2,c.maxValue=this._getMaxValue(a,c),c.step=this._getPointStep(a,c),c},_getGraphPoints:function(a,b){var c=this,d=this._getPointStep(a,b),e=this._getMaxValue(a,b);return _.map(a,function(a,f){return b.paddingLeft+d*f+","+(-b.paddingTop-c._getValue(a)*b.graphHeight/e)})},_getPointStep:function(a,b){return b.step||b.graphWidth/(a.length-1)},renderShape:function(a,b){var c=this._mergeGraphOptions(b||{}),d=this._getGraphPoints(a,c);return d.unshift(_.first(d).replace(/,[0-9.-]+/,"")+","+-c.paddingTop),d.push(_.last(d).replace(/,[0-9.-]+/,"")+","+-c.paddingTop),this._render("polyline",_.extend(c,{points:d.join(" "),"class":this.options.shapeClass+" "+(c["class"]||"")})),this},renderLine:function(a,b){var c=this._mergeGraphOptions(b||{}),d=this._getGraphPoints(a,c);return this._render("polyline",_.extend(c,{points:d.join(" "),"class":this.options.lineClass})),this},renderPoints:function(a,b){var c=this,d=this._getPointsGraphOptions(a,b);return _.each(a,function(a,b){var e=d.paddingTop+c._getValue(a)*d.graphHeight/d.maxValue;c._render("circle",_.extend({},"object"==typeof a?a:{},{cx:d.paddingLeft+d.step*b,cy:-e,r:d.pointRadius,value:c._getValue(a),"class":c.options.pointClass}))}),this},renderPointsValues:function(a,b){var c=this,d=this._getPointsGraphOptions(a,b),e=this._renderGroup(d["class"]||"");return this._renderTextGlow(d,e),_.each(a,function(a,b){var f=d.paddingTop+c.options.valueOffsetY+d.pointRadius+c._getValue(a)*d.graphHeight/d.maxValue||0,g=d.paddingLeft+d.step*b,h=c._render("text",_.extend({},"object"==typeof a?a:{},{x:g,y:-f,"class":c.options.valueClass}),e);c._appendTextNodes(d.fullText?c._getValue(a):c._getValueShortText(c._getValue(a)),{x:g,y:-f,isBottomBaseLine:!0},h)}),this}}),_.extend(window.Graph.prototype,{_getDefaultRectWidth:function(a,b){return Math.round(b.graphWidth/a.length-("function"==typeof b.step?this._getRectStepsTotal(a,b)/a.length:b.step))},_getRectGraphOptions:function(a,b){var c=this._mergeGraphOptions(b);return c.step=c.step||this.options.rectStep,c.defaultRectWidth=this._getDefaultRectWidth(a,c),c.rectWidth=c.rectWidth||c.defaultRectWidth,c.maxValue=this._getMaxValue(a,c),c.previousEndsX=c.paddingLeft,c},_getRectOptions:function(a,b,c){var d={},e="function"==typeof c.step?c.step(a,b,this.options.rectStep):Math.round(c.step);return d.width="function"==typeof c.rectWidth?c.rectWidth(a,b,c.defaultRectWidth):Math.round(c.rectWidth),d.height=Math.round(this._getValue(a)*c.graphHeight/c.maxValue)||0,d.x=c.previousEndsX,d.y=-c.paddingTop-d.height,c.previousEndsX=d.x+e+d.width,d},_getRectStepsTotal:function(a,b){var c=0;return _.reduce(a,function(a,d){return a+=b.step(d,c++)},0)},_renderRect:function(a,b,c){return this._render("rect",{x:b.x,y:b.y,width:b.width,height:b.height,value:this._getValue(a),"class":this.options.rectClass+" "+(a["class"]||"")},c)},_renderRectName:function(a,b,c){var d=b.x+b.width/2,e=b.y+this.options.valueOffsetY+b.height,f=this._render("text",{x:d,y:e,"class":this.options.rectNameClass+" "+(a["class"]||"")},c);return this._appendTextNodes(a.name,{x:d,y:e},f),f},_renderRectValue:function(a,b,c,d){var e=b.x+b.width/2,f=b.y-this.options.valueOffsetY,g=this._render("text",_.extend({},"object"==typeof a?a:{},{x:e,y:f,"class":this.options.valueClass+" "+(a["class"]||"")}),d);return this._appendTextNodes(c.fullText?this._getValue(a):this._getValueShortText(this._getValue(a)),{x:e,y:f,isBottomBaseLine:!0},g),g},renderRectDiagram:function(a,b){var c=this,d=this._getRectGraphOptions(a,b||{}),e=this._renderGroup(this.options.rectDiagramClass,d),f=this._renderGroup(this.options.rectDiagramClass,d);return this._renderTextGlow(d,f),_.each(a,function(a,b){var g=c._getRectOptions(a,b,d);a.name&&c._renderRectName(a,g,f),c._renderRect(a,g,e)}),this},renderRectsValues:function(a,b){var c=this,d=this._getRectGraphOptions(a,b||{}),e=this._renderGroup(this.options.rectDiagramClass,d);return this._renderTextGlow(d,e),_.each(a,function(a,b){var f=c._getRectOptions(a,b,d);c._renderRectValue(a,f,d,e)}),this}});